<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D√©tails des T√¢ches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .done { text-decoration: line-through; opacity: 0.5; }
    </style>
</head>
<body class="bg-[#F1F5F9] text-slate-900 font-sans">

</nav>




<nav class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm sticky top-0 z-40">
        <div class="flex items-center gap-6">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <span class="bg-indigo-600 text-white p-1.5 rounded-lg text-sm">GP</span> Pilotage
            </h1>

            
            <div id="workflow-status" class="flex items-center gap-2 px-3 py-1 rounded-full border border-slate-200 bg-white text-[11px] font-bold text-slate-500">
    <span id="workflow-dot" class="w-2 h-2 rounded-full bg-slate-300"></span>
    <span id="workflow-text">ACTIONS : IDLE</span>
</div>


                  
     
        <a href="index.html" class="text-indigo-600 font-bold flex items-center gap-2 hover:underline">
            ‚Üê Retour au Planning
        </a>
        <div id="save-status" class="text-[11px] font-bold px-3 py-1 rounded-full border border-slate-200 bg-white opacity-0 transition-all duration-300 italic"></div>
    </nav>












    

    <main class="max-w-3xl mx-auto">
        <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-8 mb-6">
            <h1 id="project-title" class="text-2xl font-bold text-slate-800">Chargement du projet...</h1>
            <p id="project-info" class="text-slate-500 text-sm mt-1 italic"></p>
        </header>

<section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 mb-6">
    <div class="flex flex-wrap gap-2">
        <input type="text" id="task-desc" placeholder="Nouvelle t√¢che..." 
               class="flex-1 min-w-[200px] p-3 rounded-lg bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">
        
        <input type="number" id="task-time" placeholder="Hrs" title="Temps estim√© en heures"
               class="w-20 p-3 rounded-lg bg-slate-50 border border-slate-200 outline-none focus:ring-2 focus:ring-indigo-500">

        <select id="task-who" class="p-3 rounded-lg bg-slate-50 border border-slate-200 outline-none w-40"></select>
        
        <button onclick="addTask()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-md">
            +
        </button>
    </div>
</section>

        <div id="task-list" class="space-y-3">
            </div>
    </main>

    <script>
        const REPO_NAME = "mikefri/Pilotage_Projet";
        let allTasks = []; // Toutes les t√¢ches de tous les projets
        let responsables = [];
        let currentProjectId = new URLSearchParams(window.location.search).get('id');

        // Fonctions de camouflage
        const dec = (str) => { try { return decodeURIComponent(escape(atob(str))); } catch(e) { return str; } };
        const enc = (str) => btoa(unescape(encodeURIComponent(str)));

        async function init() {
            if (!currentProjectId) {
                document.getElementById('project-title').innerText = "Aucun projet s√©lectionn√©";
                return;
            }
            await loadData();
        }

        async function loadData() {
    // --- NOUVEAU : CHARGEMENT DU CACHE LOCAL (INSTANTAN√â) ---
    const localTasks = localStorage.getItem('cache_taches');
    const localResp = localStorage.getItem('cache_responsables');
    const localProj = localStorage.getItem('cache_projects');

    if (localTasks) allTasks = JSON.parse(localTasks);
    if (localResp) responsables = JSON.parse(localResp);
    
    // Affichage imm√©diat des donn√©es du cache
    if (responsables.length > 0) {
        document.getElementById('task-who').innerHTML = responsables.map(r => `<option value="${r}">${dec(r)}</option>`).join('');
    }
    if (localProj && currentProjectId) {
        const p = JSON.parse(localProj).find(i => i.id === currentProjectId);
        if(p) document.getElementById('project-title').innerText = "üìù Liste des T√¢ches : " + p.name;
    }
    renderTasks();

    try {
        // --- 1. Synchronisation des responsables ---
        const resR = await fetch(`https://raw.githubusercontent.com/${REPO_NAME}/main/responsables.json?t=${Date.now()}`);
        if (resR.ok) {
            responsables = await resR.json();
            localStorage.setItem('cache_responsables', JSON.stringify(responsables));
            document.getElementById('task-who').innerHTML = responsables.map(r => `<option value="${r}">${dec(r)}</option>`).join('');
        }

        // --- 2. Synchronisation des t√¢ches existantes ---
        const resT = await fetch(`https://raw.githubusercontent.com/${REPO_NAME}/main/taches.json?t=${Date.now()}`);
        if (resT.ok) {
            allTasks = await resT.json();
            localStorage.setItem('cache_taches', JSON.stringify(allTasks));
        }

        // --- 3. Synchronisation du titre (data.json) ---
        const resP = await fetch(`https://raw.githubusercontent.com/${REPO_NAME}/main/data.json?t=${Date.now()}`);
        if (resP.ok) {
            const projects = await resP.json();
            localStorage.setItem('cache_projects', JSON.stringify(projects));
            const p = projects.find(i => i.id === currentProjectId);
            if(p) document.getElementById('project-title').innerText = "üìù Liste des T√¢ches : " + p.name;
        }

        // Mise √† jour finale apr√®s r√©ception des donn√©es GitHub
        renderTasks();

    } catch (e) { 
        console.error("D√©lai GitHub ou erreur r√©seau : utilisation des donn√©es locales.", e); 
    }
}

        function renderTasks() {
            const listEl = document.getElementById('task-list');
            // On ne filtre que les t√¢ches li√©es √† ce projet
            const projectTasks = allTasks.filter(t => t.projectId === currentProjectId);

            if(projectTasks.length === 0) {
                listEl.innerHTML = '<p class="text-center text-slate-400 py-10 italic">Aucune t√¢che pour le moment.</p>';
                return;
            }

            listEl.innerHTML = projectTasks.map(t => `
                <div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-xl shadow-sm ${t.done ? 'done' : ''}">
                    <div class="flex items-center gap-4">
                        <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-600 cursor-pointer">
                     <div>
    <p class="font-bold text-slate-700">${t.desc}</p>
    <div class="flex gap-3 items-center mt-1">
        <p class="text-[10px] text-slate-400 font-bold uppercase">üë§ ${dec(t.who)}</p>
        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">
            ‚è±Ô∏è ${t.time} h
        </span>
    </div>
</div>
                    </div>
                    <button onclick="deleteTask('${t.id}')" class="text-red-300 hover:text-red-600 px-2">&times;</button>
                </div>
            `).join('');
        }

async function addTask() {
    const desc = document.getElementById('task-desc').value.trim();
    const time = document.getElementById('task-time').value || 0; // R√©cup√®re le temps
    const who = document.getElementById('task-who').value;
    
    if(!desc) return;

    const newTask = {
        id: "TASK-" + Date.now(),
        projectId: currentProjectId,
        desc: desc,
        time: time, // Nouveau champ enregistr√© dans taches.json
        who: who,
        done: false
    };

    allTasks.push(newTask);
    document.getElementById('task-desc').value = '';
    document.getElementById('task-time').value = ''; // Reset du champ temps
    renderTasks();
    await saveToGitHub();
}

        async function toggleTask(id) {
            const t = allTasks.find(item => item.id === id);
            if(t) t.done = !t.done;
            renderTasks();
            await saveToGitHub();
        }

        async function deleteTask(id) {
            allTasks = allTasks.filter(t => t.id !== id);
            renderTasks();
            await saveToGitHub();
        }

        async function saveToGitHub() {
    const token = localStorage.getItem('gh_token');
    if (!token) return alert("Configurez votre token sur la page planning.");
    
    const statusLabel = document.getElementById('save-status');
    statusLabel.innerText = "‚è≥ SYNCHRONISATION..."; 
    statusLabel.style.opacity = "1";

    try {
        // 1. R√©cup√©ration du SHA actuel pour autoriser la modification
        const res = await fetch(`https://api.github.com/repos/${REPO_NAME}/contents/taches.json`, {
            headers: { 'Authorization': `token ${token}` }
        });
        
        if (!res.ok) throw new Error("Impossible de r√©cup√©rer le fichier");
        const file = await res.json();
        
        // 2. Envoi des donn√©es (allTasks contient d√©j√† vos modifs locales)
        const update = await fetch(`https://api.github.com/repos/${REPO_NAME}/contents/taches.json`, {
            method: 'PUT',
            headers: { 
                'Authorization': `token ${token}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
                message: "Update taches",
                // Encodage propre pour g√©rer les accents et le camouflage
                content: btoa(unescape(encodeURIComponent(JSON.stringify(allTasks, null, 2)))),
                sha: file.sha
            })
        });

        if (update.ok) {
            statusLabel.innerText = "‚úÖ ENREGISTR√â";
            // IMPORTANT : On ne relance PAS loadData() ici pour √©viter que 
            // le d√©lai de GitHub (cache) ne fasse revenir d'anciennes donn√©es.
            setTimeout(() => {
                statusLabel.style.opacity = "0";
            }, 2000);
        } else {
            throw new Error("√âchec de la mise √† jour");
        }
    } catch (e) { 
        console.error(e);
        statusLabel.innerText = "‚ùå ERREUR SYNC"; 
    }
}

        window.onload = init;
    </script>
</body>
</html>
